# Jivetalking - Presenter Integration Tests
# This file contains commands for testing with local audio files (not in git)

# Path to testdata directory (source_directory returns the directory of THIS file)
testdata := source_directory()

# Test episode number (change this to test different episodes)
episode := "72"

# Get Mark's processed logs
mark-logs:
    @cat {{testdata}}/LMP-{{episode}}-mark-processed.log

# Stash Mark's processed logs
mark-log-stash:
    @cp {{testdata}}/LMP-{{episode}}-mark-processed.log {{testdata}}/LMP-{{episode}}-mark-stashed.log

# Get Mark's stashed logs
mark-stashed-logs:
    @cat {{testdata}}/LMP-{{episode}}-mark-stashed.log

# Process mark audio
mark:
    @rm -f {{testdata}}/LMP-{{episode}}-mark-processed.*
    @./jivetalking --logs {{testdata}}/LMP-{{episode}}-mark.flac
    @just mark-logs

# Get Martin's processed logs
martin-logs:
    @cat {{testdata}}/LMP-{{episode}}-martin-processed.log

# Get Martin's stashed logs
martin-stashed-logs:
    @cat {{testdata}}/LMP-{{episode}}-martin-stashed.log

# Stash Martin's processed logs
martin-log-stash:
    @cp {{testdata}}/LMP-{{episode}}-martin-processed.log {{testdata}}/LMP-{{episode}}-martin-stashed.log

# Process martin audio
martin:
    @rm -f {{testdata}}/LMP-{{episode}}-martin-processed.*
    @./jivetalking --logs {{testdata}}/LMP-{{episode}}-martin.flac
    @just martin-logs

# Get popey's processed logs
popey-logs:
    @cat {{testdata}}/LMP-{{episode}}-popey-processed.log

# Get popey's stashed logs
popey-stashed-logs:
    @cat {{testdata}}/LMP-{{episode}}-popey-stashed.log

# Stash popey's processed logs
popey-log-stash:
    @cp {{testdata}}/LMP-{{episode}}-popey-processed.log {{testdata}}/LMP-{{episode}}-popey-stashed.log

# Process popey audio
popey:
    @rm -f {{testdata}}/LMP-{{episode}}-popey-processed.*
    @./jivetalking --logs {{testdata}}/LMP-{{episode}}-popey.flac
    @just popey-logs

# Process all presenters
presenters: mark martin popey

# Process all presenters for episodes 70, 71, and 72
all-episodes:
    #!/usr/bin/env bash
    for ep in 70 71 72; do
        echo "=== Processing Episode $ep ==="
        for presenter in mark martin popey; do
            echo "--- $presenter ---"
            rm -f {{testdata}}/LMP-${ep}-${presenter}-processed.*
            ./jivetalking --logs {{testdata}}/LMP-${ep}-${presenter}.flac
        done
    done

# Show all presenters logs
logs: mark-logs martin-logs popey-logs

# Show all presenters stashed logs
stashed-logs: mark-stashed-logs martin-stashed-logs popey-stashed-logs

# Stash all presenters logs
stash: mark-log-stash martin-log-stash popey-log-stash

# =============================================================================
# Audio Analysis Commands
# Capture comprehensive measurements for AI-assisted before/after comparison
# =============================================================================

# Analyse a single audio file and output measurements
# Usage: just analyse path/to/file.flac
[no-cd]
analyse file:
    #!/usr/bin/env bash
    set -euo pipefail
    input="{{file}}"
    base="${input%.*}"
    name=$(basename "$base")

    echo "Analysing: $name"
    echo "==========================================="

    # Run comprehensive analysis with a single FFmpeg pass
    # - ebur128: loudness (LUFS, LRA, true peak)
    # - astats: time domain (noise floor, dynamic range, crest factor, etc)
    # - aspectralstats: frequency domain (centroid, rolloff, flatness, skewness, etc)
    # aspectralstats outputs per-frame metadata, captured via ametadata to file
    ffmpeg -hide_banner -nostats -i "$input" \
        -af "ebur128=metadata=1:peak=true,astats=metadata=1:measure_overall=all,aspectralstats=measure=all,ametadata=mode=print:file=${base}-spectral-raw.txt" \
        -f null - 2>&1 | grep -vE "^Input|^Output|Stream #|encoder|^Press|Metadata:|Duration:|mapping|video:.KiB|size=N/A" | tee "${base}-analysis.txt"

    # Compute spectral statistics summary from per-frame data
    echo "" >> "${base}-analysis.txt"
    echo "Spectral Statistics (averaged over all frames):" >> "${base}-analysis.txt"
    awk -F= '
        /aspectralstats\.1\.centroid/ { sum_centroid += $2; n_centroid++ }
        /aspectralstats\.1\.spread/ { sum_spread += $2; n_spread++ }
        /aspectralstats\.1\.skewness/ { sum_skewness += $2; n_skewness++ }
        /aspectralstats\.1\.kurtosis/ { sum_kurtosis += $2; n_kurtosis++ }
        /aspectralstats\.1\.entropy/ { sum_entropy += $2; n_entropy++ }
        /aspectralstats\.1\.flatness/ { sum_flatness += $2; n_flatness++ }
        /aspectralstats\.1\.crest/ { sum_crest += $2; n_crest++ }
        /aspectralstats\.1\.slope/ { sum_slope += $2; n_slope++ }
        /aspectralstats\.1\.decrease/ { sum_decrease += $2; n_decrease++ }
        /aspectralstats\.1\.rolloff/ { sum_rolloff += $2; n_rolloff++ }
        END {
            if (n_centroid > 0) printf "  Spectral centroid: %.2f Hz\n", sum_centroid/n_centroid
            if (n_spread > 0) printf "  Spectral spread: %.2f Hz\n", sum_spread/n_spread
            if (n_skewness > 0) printf "  Spectral skewness: %.4f\n", sum_skewness/n_skewness
            if (n_kurtosis > 0) printf "  Spectral kurtosis: %.4f\n", sum_kurtosis/n_kurtosis
            if (n_entropy > 0) printf "  Spectral entropy: %.6f\n", sum_entropy/n_entropy
            if (n_flatness > 0) printf "  Spectral flatness: %.6f\n", sum_flatness/n_flatness
            if (n_crest > 0) printf "  Spectral crest: %.2f\n", sum_crest/n_crest
            if (n_slope > 0) printf "  Spectral slope: %.8f\n", sum_slope/n_slope
            if (n_decrease > 0) printf "  Spectral decrease: %.6f\n", sum_decrease/n_decrease
            if (n_rolloff > 0) printf "  Spectral rolloff: %.2f Hz\n", sum_rolloff/n_rolloff
        }
    ' "${base}-spectral-raw.txt" | tee -a "${base}-analysis.txt"

    # Clean up raw spectral data (it's large)
    rm -f "${base}-spectral-raw.txt"

    echo ""
    echo "Saved: ${base}-analysis.txt"

# Generate spectrum image for a single file
[no-cd]
spectrum file:
    #!/usr/bin/env bash
    set -euo pipefail
    input="{{file}}"
    base="${input%.*}"
    name=$(basename "$base")
    echo "Generating spectrum: $name"
    ffmpeg -hide_banner -loglevel error -stats -i "$input" \
        -lavfi "showspectrumpic=s=1920x1080:legend=1:start=0:stop=8000:scale=log:color=intensity" \
        "${base}-spectrum.png" -y
    echo "  → ${base}-spectrum.png"

# Generate low-frequency spectrum (0-800Hz) for hum/voice fundamental analysis
[no-cd]
spectrum-lf file:
    #!/usr/bin/env bash
    set -euo pipefail
    input="{{file}}"
    base="${input%.*}"
    name=$(basename "$base")
    echo "Generating LF spectrum: $name"
    ffmpeg -hide_banner -loglevel error -stats -i "$input" \
        -lavfi "showspectrumpic=s=1920x1080:legend=1:start=0:stop=800:scale=lin:fscale=lin:color=intensity" \
        "${base}-spectrum-lf.png" -y
    echo "  → ${base}-spectrum-lf.png"

# Full analysis: measurements + spectrum images for a single file
# Combined filter chain: analysis + full spectrum in one pass, then LF spectrum
# Skips analysis if output files already exist
[no-cd]
analyse-full file:
    #!/usr/bin/env bash
    set -euo pipefail
    input="{{file}}"
    base="${input%.*}"
    name=$(basename "$base")

    # Check if all output files exist
    if [[ -f "${base}-analysis.txt" && -f "${base}-spectrum.png" && -f "${base}-spectrum-lf.png" ]]; then
        echo "Analysis files already exist for: $name"
        echo "  ${base}-analysis.txt"
        echo "  ${base}-spectrum.png"
        echo "  ${base}-spectrum-lf.png"
        echo "Skipping analysis (delete files to regenerate)."
        exit 0
    fi

    echo "Full analysis: $name"
    echo "==========================================="

    # Combined pass: audio analysis + full spectrum image
    # Uses asplit to process audio through analysis chain AND generate spectrum simultaneously
    # - ebur128: loudness (LUFS, LRA, true peak) per EBU R128
    # - astats: time domain (noise floor, dynamic range, crest factor, entropy, etc)
    # - aspectralstats: frequency domain (centroid, rolloff, flatness, skewness, etc)
    echo "Pass 1/2: Audio measurements + full spectrum..."
    ffmpeg -hide_banner -nostats -i "$input" \
        -filter_complex "[0:a]asplit=2[a1][a2]; \
            [a1]ebur128=metadata=1:peak=true,astats=metadata=1:measure_overall=all,aspectralstats=measure=all,ametadata=mode=print:file=${base}-spectral-raw.txt[outa]; \
            [a2]showspectrumpic=s=1920x1080:legend=1:start=0:stop=8000:scale=log:color=intensity[outv]" \
        -map "[outa]" -f null - \
        -map "[outv]" -frames:v 1 -update 1 "${base}-spectrum.png" -y 2>&1 | grep -vE "^Input|^Output|Stream #|encoder|^Press|Metadata:|Duration:|mapping|video:.KiB|size=N/A|^frame:|buffers queued|something may be wrong|does not contain|Use a pattern|\[out#" | tee "${base}-analysis.txt"

    # Compute spectral statistics summary from per-frame data
    echo "" >> "${base}-analysis.txt"
    echo "Spectral Statistics (averaged over all frames):" >> "${base}-analysis.txt"
    awk -F= '
        /aspectralstats\.1\.centroid/ { sum_centroid += $2; n_centroid++ }
        /aspectralstats\.1\.spread/ { sum_spread += $2; n_spread++ }
        /aspectralstats\.1\.skewness/ { sum_skewness += $2; n_skewness++ }
        /aspectralstats\.1\.kurtosis/ { sum_kurtosis += $2; n_kurtosis++ }
        /aspectralstats\.1\.entropy/ { sum_entropy += $2; n_entropy++ }
        /aspectralstats\.1\.flatness/ { sum_flatness += $2; n_flatness++ }
        /aspectralstats\.1\.crest/ { sum_crest += $2; n_crest++ }
        /aspectralstats\.1\.slope/ { sum_slope += $2; n_slope++ }
        /aspectralstats\.1\.decrease/ { sum_decrease += $2; n_decrease++ }
        /aspectralstats\.1\.rolloff/ { sum_rolloff += $2; n_rolloff++ }
        END {
            if (n_centroid > 0) printf "  Spectral centroid: %.2f Hz\n", sum_centroid/n_centroid
            if (n_spread > 0) printf "  Spectral spread: %.2f Hz\n", sum_spread/n_spread
            if (n_skewness > 0) printf "  Spectral skewness: %.4f\n", sum_skewness/n_skewness
            if (n_kurtosis > 0) printf "  Spectral kurtosis: %.4f\n", sum_kurtosis/n_kurtosis
            if (n_entropy > 0) printf "  Spectral entropy: %.6f\n", sum_entropy/n_entropy
            if (n_flatness > 0) printf "  Spectral flatness: %.6f\n", sum_flatness/n_flatness
            if (n_crest > 0) printf "  Spectral crest: %.2f\n", sum_crest/n_crest
            if (n_slope > 0) printf "  Spectral slope: %.8f\n", sum_slope/n_slope
            if (n_decrease > 0) printf "  Spectral decrease: %.6f\n", sum_decrease/n_decrease
            if (n_rolloff > 0) printf "  Spectral rolloff: %.2f Hz\n", sum_rolloff/n_rolloff
        }
    ' "${base}-spectral-raw.txt" | tee -a "${base}-analysis.txt"

    # Clean up raw spectral data
    rm -f "${base}-spectral-raw.txt"

    # LF spectrum (separate pass - showspectrumpic can't output multiple images)
    echo ""
    echo "Pass 2/2: Low-frequency spectrum (0-800Hz)..."
    ffmpeg -hide_banner -loglevel error -stats -i "$input" \
        -lavfi "showspectrumpic=s=1920x1080:legend=1:start=0:stop=800:scale=lin:fscale=lin:color=intensity" \
        "${base}-spectrum-lf.png" -y

    echo ""
    echo "Output files:"
    echo "  ${base}-analysis.txt"
    echo "  ${base}-spectrum.png"
    echo "  ${base}-spectrum-lf.png"

# Analyse before/after pair for a presenter
# Compares original .flac with -processed.flac
[no-cd]
compare file:
    #!/usr/bin/env bash
    set -euo pipefail
    input="{{file}}"
    base="${input%.*}"
    processed="${base}-processed.flac"
    name=$(basename "$base")

    if [[ ! -f "$processed" ]]; then
        echo "Error: Processed file not found: $processed"
        echo "Run jivetalking on the file first."
        exit 1
    fi

    echo "╔═══════════════════════════════════════════════════════════════"
    echo "║  Before/After Comparison: $name"
    echo "╚═══════════════════════════════════════════════════════════════"
    echo ""

    # Analyse original (may skip if already exists)
    echo "▶ ORIGINAL: $input"
    echo "-------------------------------------------"
    just analyse-full "$input"

    echo ""
    echo ""

    # Analyse processed (always regenerate to check new processing results)
    echo "▶ PROCESSED: $processed"
    echo "-------------------------------------------"
    # Remove existing processed analysis files to force regeneration
    rm -f "${base}-processed-analysis.txt" "${base}-processed-spectrum.png" "${base}-processed-spectrum-lf.png"
    just analyse-full "$processed"

    echo ""
    echo "═══════════════════════════════════════════════════════════════"
    echo "Comparison complete. Files generated:"
    echo "  Original:  ${base}-analysis.txt, ${base}-spectrum.png, ${base}-spectrum-lf.png"
    echo "  Processed: ${base}-processed-analysis.txt, ${base}-processed-spectrum.png, ${base}-processed-spectrum-lf.png"

# Analyse Mark (original and processed)
mark-analyse:
    @just compare {{testdata}}/LMP-{{episode}}-mark.flac

# Analyse Martin (original and processed)
martin-analyse:
    @just compare {{testdata}}/LMP-{{episode}}-martin.flac

# Analyse popey (original and processed)
popey-analyse:
    @just compare {{testdata}}/LMP-{{episode}}-popey.flac

# Analyse all presenters (before/after)
analyse-all: mark-analyse martin-analyse popey-analyse

# Generate analysis report for AI consumption
# Creates a single markdown file with all measurements
[no-cd]
report file:
    #!/usr/bin/env bash
    set -euo pipefail
    input="{{file}}"
    base="${input%.*}"
    processed="${base}-processed.flac"
    name=$(basename "$base")
    report="${base}-report.md"

    if [[ ! -f "$processed" ]]; then
        echo "Error: Processed file not found: $processed" >&2
        exit 1
    fi

    # Ensure analysis files exist (generate silently if missing)
    if [[ ! -f "${base}-analysis.txt" ]]; then
        echo "Generating analysis for original file..."
        just analyse-full "$input" > /dev/null 2>&1
    fi
    if [[ ! -f "${base}-processed-analysis.txt" ]]; then
        echo "Generating analysis for processed file..."
        just analyse-full "$processed" > /dev/null 2>&1
    fi

    # Helper to clean FFmpeg filter output for readability
    clean_analysis() {
        sed -E 's/\[Parsed_[a-z0-9_]+[^]]*\] //g' | grep -v "^$"
    }

    # Output report to stdout
    echo "# Audio Processing Analysis Report"
    echo ""
    echo "## File Information"
    echo "- **Source:** $name"
    echo "- **Original:** $input"
    echo "- **Processed:** $processed"
    echo ""
    echo "## Original Audio Measurements"
    echo '```'
    cat "${base}-analysis.txt" | clean_analysis
    echo '```'
    echo ""
    echo "## Processed Audio Measurements"
    echo '```'
    cat "${base}-processed-analysis.txt" | clean_analysis
    echo '```'
    echo ""
    echo "## Spectrum Images"
    echo "- Original full spectrum: ${base}-spectrum.png"
    echo "- Original low frequency (0-800Hz): ${base}-spectrum-lf.png"
    echo "- Processed full spectrum: ${base}-processed-spectrum.png"
    echo "- Processed low frequency (0-800Hz): ${base}-processed-spectrum-lf.png"

# Generate report for Mark
mark-report:
    @just report {{testdata}}/LMP-{{episode}}-mark.flac

# Generate report for Martin
martin-report:
    @just report {{testdata}}/LMP-{{episode}}-martin.flac

# Generate report for popey
popey-report:
    @just report {{testdata}}/LMP-{{episode}}-popey.flac

# Generate reports for all presenters
reports: mark-report martin-report popey-report

